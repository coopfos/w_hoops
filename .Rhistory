r2 = corr^2,
.groups = "drop"
)
pair_corr <- pair_corr %>%
filter(n > 10)
pair_corr <- players %>%
select(Player, pid) %>%
right_join(pair_corr, by = c('pid' = 'pid.x')) %>%
rename(player.x = Player)
pair_corr <- pts_pairs_filt %>%
group_by(pid.x, pid.y) %>%
summarise(
n = n(),
corr = cor(pts_diff.x, pts_diff.y, use = "pairwise.complete.obs"),
r2 = corr^2,
.groups = "drop"
)
pair_corr <- pair_corr %>%
filter(n > 10)
pair_corr <- players %>%
select(Player, pid) %>%
right_join(pair_corr, by = c('pid' = 'pid.x')) %>%
rename(player.x = Player,
pid.x = pid)
pair_corr <- players %>%
select(Player, pid) %>%
right_join(pair_corr, by = c('pid' = 'pid.y')) %>%
rename(player.y = Player,
pid.y = pid)
pair_corr <- pair_corr %>%
unique()
View(pair_corr)
library(ggplot2)
str(pair_corr)
ggplot(pair_corr, aes(x = corr))+
geom_density()
ggplot(pair_corr, aes(x = corr))+
geom_histogram()
filt <- pair_corr %>%
filter(corr >= .6 |
corr <= -.6)
View(filt)
install.packages('jsonlite')
library(jsonlite)
library(dplyr)
json <- fromJSON('/Users/cooperfoster/Desktop/prizePicks/out_api/projections_20251115T120753Z.json')
str(json)
df1 <- as.data.frame(json$data$type)
View(df1)
df1 <- as.data.frame(json$data$id)
View(df1)
df2 <- as.data.frame(json$data$attributes)
View(df2)
df3 <- as.data.frame(json$data$relationships)
View(df3)
str(df3)
colnames(df3) <- c('duration_type', 'duration_id', 'game_type', 'game_id',
'league_type', 'league_id', 'new_player_type', 'new_player_id',
'projection_type', 'projection_type_id', 'score', 'stat_type',
'stat_type_id')
df3 <- as.data.frame(json$data$relationships$new_player)
View(df3)
df3 <- as.data.frame(json$data$relationships$new_player$data)
View(df3)
str(json)
player_lu <- as.data.frame(json$included)
View(player_lu)
player_lu <- player_lu %>%
filter(type == "new_player")
p_lu_1 <- player_lu$id
p_lu_1 <- as.data.frame(player_lu$attributes$name)
player_lu <- as.data.frame(json$included)
player_lu <- player_lu %>%
filter(type == "new_player")
p_lu_1 <- player_lu$id
p_lu_2 <- as.data.frame(player_lu$attributes$name)
player_lu <- cbind(p_lu_1, p_lu_2)
View(p_lu_2)
View(player_lu)
colnames(df1) <- 'id'
colnames(df3) <- 'player_id'
colnames(df3) <- c('type', 'player_id')
colnames(player_lu) <- c('player_id', 'player_name')
bind <- cbind(df1, df2, df3)
View(bind)
stats <- bind %>%
left_join(player_lu, by = 'player_id')
View(stats)
str(stats)
lines <- stats %>%
select(id, adjusted_odds, board_time, is_promo, line_score, odds_type, rank,
stat_type, trending_count, player_id, player_name)
write.csv(lines, '/users/cooperfoster/desktop/prizePicks/tables/output.csv')
write.csv(lines, '/users/cooperfoster/desktop/prizePicks/tables/output.csv', row.names = F)
library(dplyr)
setwd('/users/cooperfoster/desktop/w_hoops')
d1 <- read.csv('temp_data/missing_teams.csv')
d2 <- read.csv('temp_data/missing_teams2.csv')
d3 <- read.csv('temp_data/teams.csv')
d4 <- read.csv('temp_data/teams2.csv')
View(d3)
View(d4)
rm(d3)
str(d2)
id1 <- d2 %>%
select(School, link)
id2 <- d1 %>%
select(School, link)
id3 <- d4 %>%
select(School, link)
id3 <- id3 %>%
filter(!(School %in% id2$School))
id2 <- id2 %>%
filter(!(School %in% id1$School))
school_id <- rbind(id1, id2, id3)
View(school_id)
school_id <- rbind(id1, id2, id3) %>%
arrange(School)
school_id <- rbind(id1, id2, id3) %>%
arrange(School) %>%
rename(sid = link)
View(d4)
write.csv(school_id, 'school_id.csv')
str(d4)
stats <- d4 %>%
select(-`X.5`, -link, -X, -`X.1`, -`X.2`, -`X.3`, -`X.4`)
stats <- d4 %>%
select(-`X.5`, -link, -X, -`X.1`, -`X.2`, -`X.3`, -`X.4`) %>%
left_join(school_id, by = 'School')
View(stats)
write.csv(stats, 'school_stats.csv')
games <- read.csv('gamelogs_bind.csv')
View(games)
games <- read.csv('gamelogs_bind.csv')
sid <- read.csv('school_id.csv')
str(games)
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = ('.x', '.y'))
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y'))
View(games)
View(games)
View(sid)
sid <- sid %>%
select(-X)
write.csv(sid, 'school_id.csv')
sid <- read.csv('school_id.csv')
sid <- sid %>%
select(-X)
write.csv(sid, 'school_id.csv', row.names = F)
sid <- read.csv('school_id.csv')
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y'))
games <- read.csv('gamelogs_bind.csv')
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y'))
games <- games %>%
left_join(sid, by = c('Opp' == 'School'), suffix = c('.x', '.y'))
View(sid)
games <- games %>%
left_join(
sid %>% rename(opp_sid = sid),
by = c("Opp" = "School")
)
games <- read.csv('gamelogs_bind.csv')
sid <- read.csv('school_id.csv')
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y'))
View(games)
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y')) %>%
rename(opp_sid = sid.y)
View(sid)
sid <- gsub(' NCAA', '', sid$School)
sid <- read.csv('school_id.csv')
sid$School <- gsub(' NCAA', '', sid$School)
sid$School <- gsub("[[:space:]\u00A0]*NCAA[[:space:]\u00A0]*$", "", sid$School)
write.csv(sid, 'school_id.csv', row.names = F)
games <- read.csv('gamelogs_bind.csv')
sid <- read.csv('school_id.csv')
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y')) %>%
rename(opp_sid = sid.y)
games %>% filter(is.na(opp_sid)) %>% nrow()
na_opp <- games %>%
filter(is.na(opp_sid)) %>%
select(Opp, opp_sid)
View(na_opp)
na_opp <- games %>%
filter(is.na(opp_sid)) %>%
select(Opp, opp_sid) %>%
unique()
na_opp <- games %>%
filter(is.na(opp_sid)) %>%
select(Opp, opp_sid)
na_opp <- games %>%
filter(is.na(opp_sid))
opp_sid_repl <- read.csv('na_repl.csv')
na_opp <- games %>%
filter(is.na(opp_sid)) %>%
select(-opp_sid)
str(opp_sid_repl
)
na_opp <- opp_sid_repl %>%
select(Opp, sid) %>%
right_join(na_opp, by = 'Opp')
na_opp <- opp_sid_repl %>%
select(Opp, sid) %>%
rename(opp_sid = sid) %>%
right_join(na_opp, by = 'Opp')
games <- read.csv('gamelogs_bind.csv')
sid <- read.csv('school_id.csv')
opp_sid_repl <- read.csv('na_repl.csv')
games <- games %>%
left_join(sid, by = c('Opp' = 'School'), suffix = c('.x', '.y')) %>%
rename(opp_sid = sid.y)
na_opp <- games %>%
filter(is.na(opp_sid)) %>%
select(-opp_sid)
na_opp <- opp_sid_repl %>%
select(Opp, sid) %>%
rename(opp_sid = sid) %>%
right_join(na_opp, by = 'Opp')
na_opp %>% filter(is.na(opp_sid)) %>% nrow()
games <- games %>%
filter(!(is.na(opp_sid)))
games <- rbind(games, na_opp)
games %>% filter(is.na(opp_sid)) %>% nrow()
View(games)
games <- games %>%
arrange(sid.x, Gtm)
games <- games %>%
arrange(sid.x, Gtm) %>%
rename(sid = sid.x)
str(games)
games <- games %>%
rename(g_seq = Gtm, date = Date, loc = Unnamed..3_level_1,
opp = Opp, type = Type, res = Rslt, tm_score = Tm, opp_score = Opp.1,
ot = OT, fg = FG, fga = FGA, fg_rate = FG., x3p = X3P, x3pa = X3PA,
x3p_rate = X3P., x2p = X2P, x2pa = X2PA, x2p_rate = X2P.,
eff_fg = eFG., ft = FT, fta = FTA, ft_rate = FT., orb = ORB,
drb = DRB, trb = TRB, ast = AST, stl = STL, blk = BLK,
tov = TOV, pf = PF, fg_o = FG.1, fga_o = FGA.1, fg_rate_o = FG..1,
x3p_o = X3P.1, x3pa_o = X3PA.1, x3p_rate_o = X3P..1,
x2p_o = X2P.1, x2pa_o = X2PA.1, x2p_rate_o = X2P..1,
eff_fg_o = eFG..1, ft_o = FT.1, fta_o = FTA.1, ft_rate_o = FT..1,
orb_o = ORB.1, drb_o = DRB.1, trb_o = TRB.1, ast_o = AST.1,
stl_o = STL.1, blk_o = BLK.1, tov_o = TOV.1, pf_o = PF.1)
write.csv(games, 'gamelog_clean.csv', row.names = F)
l1 <- c(34, 22, 30, 35, 27)
mean(l1)
sd(l1)^2
sd(l1)
rm(l1)
l1 <- c(2,1,3,5)
sd(l1)
rm(l1)
unique(games$loc)
games <- games %>%
mutate(is_home = ifelse(loc == "",1,0),
is_away = ifelse(loc == "@",1,0),
is_neutral = ifelse(loc == "N",1,0))
sum(games$is_home, games$is_away, games$is_neutral)
write.csv(games, 'gamelog_clean.csv', row.names = F)
games <- games %>%
mutate(is_home = ifelse(loc == "",1,0),
is_away = ifelse(loc == "@",1,0),
is_neutral = ifelse(loc == "N",1,0)) %>%
select(-loc)
str(games)
unique(games$res)
write.csv(games, 'gamelog_clean.csv', row.names = F)
library(dplyr)
library(randomForest)
set.seed(123)
raw_path <- "main_data/gamelog_clean.csv"
games <- read.csv(raw_path, stringsAsFactors = FALSE)
# Target variable
games <- games %>%
mutate(
game_date = as.Date(date),
win = ifelse(res == "W", 1L, 0L)
)
# Box score stats we can use to build pre-game form indicators
stat_cols <- c(
"fg_rate", "x3p_rate", "x2p_rate", "eff_fg", "ft_rate",
"orb", "drb", "trb", "ast", "stl", "blk", "tov", "pf",
"fg_rate_o", "x3p_rate_o", "x2p_rate_o", "eff_fg_o", "ft_rate_o",
"orb_o", "drb_o", "trb_o", "ast_o", "stl_o", "blk_o", "tov_o", "pf_o"
)
# Build team-level prior (cumulative) averages so that each row only uses information available before tip-off
games_features <- games %>%
arrange(sid, game_date) %>%
group_by(sid) %>%
mutate(
across(
all_of(stat_cols),
~ lag(cummean(.x)),
.names = "prior_{.col}"
)
) %>%
ungroup() %>%
mutate(
is_home = as.integer(is_home),
is_away = as.integer(is_away),
is_neutral = as.integer(is_neutral)
) %>%
select(
sid, opp_sid, game_date, g_seq, win,
starts_with("prior_"), is_home, is_away, is_neutral
) %>%
# Drop games with missing prior info (mostly season openers or missing opponent IDs)
tidyr::drop_na()
data.frame(
rows_after_filter = nrow(games_features),
class_balance = table(games_features$win)
)
View(games_features)
games_features <- games_features %>%
mutate(row_id = row_number())
train_ids <- games_features %>%
group_by(win) %>%
sample_frac(0.8) %>%
pull(row_id)
train_df <- games_features %>% filter(row_id %in% train_ids) %>% select(-row_id)
valid_df <- games_features %>% filter(!row_id %in% train_ids) %>% select(-row_id)
metrics <- function(probs, truth) {
eps <- 1e-15
truth01 <- as.integer(truth)
pred_class <- ifelse(probs >= 0.5, 1L, 0L)
accuracy <- mean(pred_class == truth01)
brier <- mean((probs - truth01)^2)
log_loss <- -mean(truth01 * log(pmax(eps, probs)) + (1 - truth01) * log(pmax(eps, 1 - probs)))
# AUC using the Wilcoxon-Mann-Whitney formulation
ranks <- rank(probs, ties.method = "average")
pos <- truth01 == 1
n_pos <- sum(pos)
n_neg <- length(probs) - n_pos
auc <- if (n_pos > 0 && n_neg > 0) {
(sum(ranks[pos]) - n_pos * (n_pos + 1) / 2) / (n_pos * n_neg)
} else {
NA_real_
}
data.frame(accuracy = accuracy, brier = brier, log_loss = log_loss, auc = auc)
}
glm_formula <- as.formula(
paste(
"win ~ g_seq + is_home + is_away + is_neutral +",
paste(names(train_df)[grepl('^prior_', names(train_df))], collapse = " + ")
)
)
glm_fit <- glm(glm_formula, data = train_df, family = binomial())
glm_valid_probs <- predict(glm_fit, newdata = valid_df, type = "response")
glm_metrics <- metrics(glm_valid_probs, valid_df$win)
glm_metrics
rf_formula <- glm_formula
rf_fit <- randomForest(
x = train_df %>% select(-win),
y = factor(train_df$win),
ntree = 400,
mtry = floor(sqrt(ncol(train_df) - 1)),
importance = TRUE
)
rf_valid_probs <- predict(rf_fit, newdata = valid_df %>% select(-win), type = "prob")[, "1"]
rf_metrics <- metrics(rf_valid_probs, valid_df$win)
rf_metrics
model_metrics <- dplyr::bind_rows(
glm = glm_metrics,
random_forest = rf_metrics,
.id = "model"
)
model_metrics
library(dplyr)
library(randomForest)
set.seed(123)
raw_path <- "main_data/gamelog_clean.csv"
games <- read.csv(raw_path, stringsAsFactors = FALSE)
# Target variable
games <- games %>%
mutate(
game_date = as.Date(date),
win = ifelse(res == "W", 1L, 0L),
score_diff = tm_score - opp_score
)
# Box score stats we can use to build pre-game form indicators
stat_cols <- c(
"fg_rate", "x3p_rate", "x2p_rate", "eff_fg", "ft_rate",
"orb", "drb", "trb", "ast", "stl", "blk", "tov", "pf",
"fg_rate_o", "x3p_rate_o", "x2p_rate_o", "eff_fg_o", "ft_rate_o",
"orb_o", "drb_o", "trb_o", "ast_o", "stl_o", "blk_o", "tov_o", "pf_o"
)
# Build team-level prior (cumulative) averages so that each row only uses information available before tip-off
games_features <- games %>%
arrange(sid, game_date) %>%
group_by(sid) %>%
mutate(
across(
all_of(stat_cols),
~ lag(cummean(.x)),
.names = "prior_{.col}"
)
) %>%
ungroup() %>%
mutate(
is_home = as.integer(is_home),
is_away = as.integer(is_away),
is_neutral = as.integer(is_neutral)
) %>%
select(
sid, opp_sid, game_date, g_seq, win, score_diff,
starts_with("prior_"), is_home, is_away, is_neutral
) %>%
# Drop games with missing prior info (mostly season openers or missing opponent IDs)
tidyr::drop_na()
games_features %>%
summarise(
rows_after_filter = n(),
wins = sum(win),
losses = n() - sum(win),
avg_score_diff = mean(score_diff)
) %>%
print()
games_features <- games_features %>%
mutate(row_id = row_number())
train_ids <- games_features %>%
group_by(win) %>%
sample_frac(0.8) %>%
pull(row_id)
train_df <- games_features %>% filter(row_id %in% train_ids) %>% select(-row_id)
valid_df <- games_features %>% filter(!row_id %in% train_ids) %>% select(-row_id)
# predictors will exclude the observed outcome win and final score_diff
predictor_cols <- setdiff(names(train_df), c("win", "score_diff"))
metrics <- function(probs, truth, score_diff) {
eps <- 1e-15
truth01 <- as.integer(truth)
pred_class <- ifelse(probs >= 0.5, 1L, 0L)
accuracy <- mean(pred_class == truth01)
brier <- mean((probs - truth01)^2)
log_loss <- -mean(truth01 * log(pmax(eps, probs)) + (1 - truth01) * log(pmax(eps, 1 - probs)))
# AUC using the Wilcoxon-Mann-Whitney formulation
ranks <- rank(probs, ties.method = "average")
pos <- truth01 == 1
n_pos <- sum(pos)
n_neg <- length(probs) - n_pos
auc <- if (n_pos > 0 && n_neg > 0) {
(sum(ranks[pos]) - n_pos * (n_pos + 1) / 2) / (n_pos * n_neg)
} else {
NA_real_
}
# Relate win probabilities to final margin; higher probs should align with larger positive margins
pearson_corr <- suppressWarnings(cor(probs, score_diff, method = "pearson"))
spearman_corr <- suppressWarnings(cor(probs, score_diff, method = "spearman"))
margin_fit <- lm(score_diff ~ probs)
margin_rmse <- sqrt(mean(residuals(margin_fit)^2))
data.frame(
accuracy = accuracy,
brier = brier,
log_loss = log_loss,
auc = auc,
margin_corr_pearson = pearson_corr,
margin_corr_spearman = spearman_corr,
margin_rmse = margin_rmse
)
}
# Evaluation now covers both classification quality (accuracy, Brier, log loss, AUC)
# and how well the win probabilities line up with eventual score margin (Pearson/Spearman correlations and RMSE from a simple margin ~ prob regression).
glm_formula <- as.formula(
paste(
"win ~ g_seq + is_home + is_away + is_neutral +",
paste(names(train_df)[grepl('^prior_', names(train_df))], collapse = " + ")
)
)
glm_fit <- glm(glm_formula, data = train_df, family = binomial())
glm_valid_probs <- predict(glm_fit, newdata = valid_df, type = "response")
glm_metrics <- metrics(glm_valid_probs, valid_df$win, valid_df$score_diff)
glm_metrics
rf_formula <- glm_formula
rf_fit <- randomForest(
x = train_df %>% select(all_of(predictor_cols)),
y = factor(train_df$win),
ntree = 400,
mtry = floor(sqrt(length(predictor_cols))),
importance = TRUE
)
rf_valid_probs <- predict(rf_fit, newdata = valid_df %>% select(all_of(predictor_cols)), type = "prob")[, "1"]
rf_metrics <- metrics(rf_valid_probs, valid_df$win, valid_df$score_diff)
rf_metrics
model_metrics <- dplyr::bind_rows(
glm = glm_metrics,
random_forest = rf_metrics,
.id = "model"
)
model_metrics
dir.create("outputs", showWarnings = FALSE)
preds_out <- valid_df %>%
mutate(
glm_win_prob = glm_valid_probs,
rf_win_prob = rf_valid_probs
) %>%
select(sid, opp_sid, game_date, g_seq, win, glm_win_prob, rf_win_prob)
write.csv(preds_out, "outputs/win_prob_validation_predictions.csv", row.names = FALSE)
game_links <- read.csv('/game_links.csv')
game_links <- read.csv('game_links.csv')
View(game_links)
str(game_links)
games_w <- game_links %>%
filter(gender == "women")
write.csv(games_w, 'games_w.csv', row.names = F)
game_links <- read.csv('game_links_2025.csv')
games_w <- game_links %>%
filter(gender == "women")
write.csv(games_w, 'games_w_2025.csv', row.names = F)
